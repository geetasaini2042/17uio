<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Stream - Video.js Player</title>

  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/8.20.0/video-js.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    .video-wrapper {
      margin-bottom: 20px;
    }
    .movie-title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .description-toggle {
      color: #00aeff;
      cursor: pointer;
      user-select: none;
      margin-bottom: 10px;
      display: inline-block;
    }
    .movie-description {
      display: none;
      line-height: 1.5;
      margin-bottom: 20px;
      white-space: pre-wrap;
    }
    .related-movies {
      margin-top: 30px;
    }
    .related-movies h3 {
      margin-bottom: 15px;
      border-bottom: 1px solid #333;
      padding-bottom: 8px;
    }
    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
    }
    .related-grid img {
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.3s ease;
      object-fit: cover;
      height: 210px;
      background: #222;
    }
    .related-grid img:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }
    .error {
      color: #ff4c4c;
      text-align: center;
      margin: 40px 0;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="video-wrapper">
    <video
      id="movie-player"
      class="video-js vjs-default-skin"
      controls
      preload="auto"
      width="100%"
      height="400"
      poster=""
      data-setup='{}'
      playsinline
    >
      <source src="" type="video/mp4" />
      <p class="vjs-no-js">
        To view this video please enable JavaScript, and consider upgrading to a
        web browser that
        <a href="https://videojs.com/html5-video-support/" target="_blank"
          >supports HTML5 video</a
        >
      </p>
    </video>
  </div>

  <div class="movie-title" id="movie-title">Loading...</div>
  <div class="description-toggle" id="desc-toggle">Show Description ⯈</div>
  <div class="movie-description" id="movie-description"></div>

  <div class="related-movies">
    <h3>Related Movies</h3>
    <div class="related-grid" id="related-container">
      <p>Loading related movies...</p>
    </div>
  </div>
</div>

<!-- Video.js JS -->
<script src="https://vjs.zencdn.net/8.20.0/video.min.js"></script>

<script>
  const tmdbApiKey = "8723ad7aaba98483edee474a2abc3c80";
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get("id");

  // Toggle description visibility
  document.getElementById('desc-toggle').addEventListener('click', () => {
    const desc = document.getElementById('movie-description');
    const toggle = document.getElementById('desc-toggle');
    if (desc.style.display === 'none' || desc.style.display === '') {
      desc.style.display = 'block';
      toggle.textContent = "Hide Description ⯆";
    } else {
      desc.style.display = 'none';
      toggle.textContent = "Show Description ⯈";
    }
  });

  if (!id) {
    document.body.innerHTML = "<p style='text-align:center;padding:20px;'>⚠️ Please provide a movie id in the URL like <code>?id=12345</code></p>";
  } else {
    // Fetch movie details
    fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${tmdbApiKey}&language=en-US`)
      .then(res => res.json())
      .then(movie => {
        if (movie.success === false) throw new Error("Movie not found");
        document.getElementById("movie-title").textContent = `${movie.title} (${movie.release_date?.split('-')[0] || ''})`;
        document.getElementById("movie-description").textContent = movie.overview || "No description available.";

        // Set poster on video player
        const player = videojs('movie-player');
        player.poster(`https://image.tmdb.org/t/p/w780${movie.backdrop_path || movie.poster_path}`);

        // Fetch related movies by genre
        const genreId = movie.genres && movie.genres.length ? movie.genres[0].id : null;
        if (genreId) {
          fetch(`https://api.themoviedb.org/3/discover/movie?api_key=${tmdbApiKey}&with_genres=${genreId}&language=en-US`)
            .then(res => res.json())
            .then(data => {
              const relatedContainer = document.getElementById('related-container');
              relatedContainer.innerHTML = '';
              if (data.results && data.results.length > 0) {
                data.results.slice(0, 10).forEach(m => {
                  if (!m.poster_path) return;
                  const img = document.createElement('img');
                  img.src = `https://image.tmdb.org/t/p/w342${m.poster_path}`;
                  img.title = m.title;
                  img.alt = m.title;
                  img.onclick = () => window.location.href = `?id=${m.id}`;
                  relatedContainer.appendChild(img);
                });
              } else {
                relatedContainer.innerHTML = '<p>No related movies found.</p>';
              }
            })
            .catch(() => {
              document.getElementById('related-container').innerHTML = '<p class="error">Error loading related movies.</p>';
            });
        } else {
          document.getElementById('related-container').innerHTML = '<p>No related movies found.</p>';
        }
      })
      .catch(() => {
        document.getElementById("movie-title").textContent = "❌ Error loading movie details.";
      });

    // Fetch video stream and set source in video.js player
    fetch(`https://sainipankaj12.serv00.net/Movies/get.php?id=${id}`)
      .then(res => res.json())
      .then(data => {
        if (!data.url) throw new Error("No video URL");

        const player = videojs('movie-player');
        player.src({ src: data.url, type: 'video/mp4' });
        player.play().catch(() => {
          // Autoplay might be blocked; user can click play
        });
      })
      .catch(() => {
        const container = document.querySelector('.video-wrapper');
        container.innerHTML = `<p class='error'>❌ Video not available.</p>`;
      });
  }
</script>

</body>
</html>
